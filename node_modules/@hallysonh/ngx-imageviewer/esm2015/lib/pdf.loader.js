/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { ResourceLoader } from './imageviewer.model';
export class PdfResourceLoader extends ResourceLoader {
    /**
     * @param {?} _imageCache
     */
    constructor(_imageCache) {
        super();
        this._imageCache = _imageCache;
        if (typeof window !== 'undefined' && 'Worker' in window) {
            if (pdfjsLib && pdfjsLib.GlobalWorkerOptions && !pdfjsLib.GlobalWorkerOptions.workerSrc) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = pdfjsWorker;
            }
        }
        this.showItemsQuantity = true;
    }
    /**
     * @return {?}
     */
    setUp() {
        const /** @type {?} */ vm = this;
        if (vm.loading || !vm.src) {
            return;
        }
        const /** @type {?} */ loadingTask = pdfjsLib.getDocument(vm.src);
        vm.loading = true;
        vm.currentItem = 1;
        loadingTask.then((pdf) => {
            vm._pdf = pdf;
            vm.totalItem = pdf.numPages;
            vm.loaded = true;
            vm.loadResource();
        }, (reason) => {
            console.error(reason);
        });
    }
    /**
     * @return {?}
     */
    loadResource() {
        const /** @type {?} */ vm = this;
        if (!vm.loaded) {
            vm._pendingReload = true;
            return;
        }
        vm.loaded = false;
        const /** @type {?} */ url = vm.src;
        const /** @type {?} */ page = vm.currentItem;
        vm._pdf.getPage(page).then((pdfPage) => {
            vm._page = pdfPage;
            vm.loadImage(url, page, () => {
                vm.loaded = true;
                vm.loading = false;
                if (vm._pendingReload) {
                    vm._pendingReload = false;
                    vm.loadResource();
                }
                else {
                    vm.resourceChange.next();
                }
            });
        });
    }
    /**
     * @param {?} src
     * @param {?} page
     * @param {?} onFinish
     * @return {?}
     */
    loadImage(src, page, onFinish) {
        const /** @type {?} */ vm = this;
        const /** @type {?} */ cacheimg = vm._imageCache.getImage(src, page);
        if (cacheimg) {
            vm._image = cacheimg;
            onFinish();
            return;
        }
        const /** @type {?} */ canvas = document.createElement('canvas');
        const /** @type {?} */ context = canvas.getContext('2d');
        const /** @type {?} */ pageVp = vm._page.getViewport(2);
        canvas.width = pageVp.width;
        canvas.height = pageVp.height;
        const /** @type {?} */ renderContext = {
            canvasContext: context,
            viewport: pageVp
        };
        const /** @type {?} */ renderTask = vm._page.render(renderContext);
        renderTask.then(function () {
            canvas.toBlob(blob => {
                const /** @type {?} */ img = new Image();
                img.onload = onFinish;
                img.src = URL.createObjectURL(blob);
                vm._imageCache.saveImage(src, page, img);
                vm._image = img;
            });
        });
    }
}
function PdfResourceLoader_tsickle_Closure_declarations() {
    /** @type {?} */
    PdfResourceLoader.prototype._pdf;
    /** @type {?} */
    PdfResourceLoader.prototype._page;
    /** @type {?} */
    PdfResourceLoader.prototype._pendingReload;
    /** @type {?} */
    PdfResourceLoader.prototype._imageCache;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGRmLmxvYWRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BoYWxseXNvbmgvbmd4LWltYWdldmlld2VyLyIsInNvdXJjZXMiOlsibGliL3BkZi5sb2FkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQTRCLE1BQU0scUJBQXFCLENBQUM7QUFRL0UsTUFBTSx3QkFBeUIsU0FBUSxjQUFjOzs7O0lBS25ELFlBQW9CLFdBQThCO1FBQ2hELEtBQUssRUFBRSxDQUFDO1FBRFUsZ0JBQVcsR0FBWCxXQUFXLENBQW1CO1FBRWhELEVBQUUsQ0FBQyxDQUFDLE9BQU8sTUFBTSxLQUFLLFdBQVcsSUFBSSxRQUFRLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQztZQUN4RCxFQUFFLENBQUMsQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLG1CQUFtQixJQUFJLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3hGLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEdBQUcsV0FBVyxDQUFDO2FBQ3REO1NBQ0Y7UUFDRCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO0tBQy9COzs7O0lBRUQsS0FBSztRQUNILHVCQUFNLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDaEIsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQUMsTUFBTSxDQUFDO1NBQUU7UUFDdEMsdUJBQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pELEVBQUUsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLEVBQUUsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFxQixFQUFFLEVBQUU7WUFDekMsRUFBRSxD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LEdBQUcsUUFBUSxDQUFDO2dCQUN0QixHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3BDLEVBQUUsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ3pDLEVBQUUsQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDO2FBQ2pCLENBQUMsQ0FBQztTQUNKLENBQUMsQ0FBQzs7Q0FFTiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlc291cmNlTG9hZGVyLCBEaW1lbnNpb24sIHRvU3F1YXJlQW5nbGUgfSBmcm9tICcuL2ltYWdldmlld2VyLm1vZGVsJztcclxuaW1wb3J0IHsgSW1hZ2VDYWNoZVNlcnZpY2UgfSBmcm9tICcuL2ltYWdlY2FjaGUuc2VydmljZSc7XHJcbmltcG9ydCB7IEltYWdlVmlld2VyQ29uZmlnIH0gZnJvbSAnLi9pbWFnZXZpZXdlci5jb25maWcnO1xyXG5pbXBvcnQgeyBQREZKU1N0YXRpYywgUERGRG9jdW1lbnRQcm94eSwgUERGUGFnZVByb3h5IH0gZnJvbSAncGRmanMtZGlzdCc7XHJcblxyXG5kZWNsYXJlIHZhciBwZGZqc0xpYjogYW55O1xyXG5kZWNsYXJlIHZhciBwZGZqc1dvcmtlcjogYW55O1xyXG5cclxuZXhwb3J0IGNsYXNzIFBkZlJlc291cmNlTG9hZGVyIGV4dGVuZHMgUmVzb3VyY2VMb2FkZXIge1xyXG4gIHByaXZhdGUgX3BkZjogUERGRG9jdW1lbnRQcm94eTtcclxuICBwcml2YXRlIF9wYWdlOiBQREZQYWdlUHJveHk7XHJcbiAgcHJpdmF0ZSBfcGVuZGluZ1JlbG9hZDogYm9vbGVhbjtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfaW1hZ2VDYWNoZTogSW1hZ2VDYWNoZVNlcnZpY2UpIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgJ1dvcmtlcicgaW4gd2luZG93KSB7XHJcbiAgICAgIGlmIChwZGZqc0xpYiAmJiBwZGZqc0xpYi5HbG9iYWxXb3JrZXJPcHRpb25zICYmICFwZGZqc0xpYi5HbG9iYWxXb3JrZXJPcHRpb25zLndvcmtlclNyYykge1xyXG4gICAgICAgIHBkZmpzTGliLkdsb2JhbFdvcmtlck9wdGlvbnMud29ya2VyU3JjID0gcGRmanNXb3JrZXI7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRoaXMuc2hvd0l0ZW1zUXVhbnRpdHkgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgc2V0VXAoKSB7XHJcbiAgICBjb25zdCB2bSA9IHRoaXM7XHJcbiAgICBpZiAodm0ubG9hZGluZyB8fCAhdm0uc3JjKSB7IHJldHVybjsgfVxyXG4gICAgY29uc3QgbG9hZGluZ1Rhc2sgPSBwZGZqc0xpYi5nZXREb2N1bWVudCh2bS5zcmMpO1xyXG4gICAgdm0ubG9hZGluZyA9IHRydWU7XHJcbiAgICB2bS5jdXJyZW50SXRlbSA9IDE7XHJcbiAgICBsb2FkaW5nVGFzay50aGVuKChwZGY6IFBERkRvY3VtZW50UHJveHkpID0+IHtcclxuICAgICAgdm0uX3BkZiA9IHBkZjtcclxuICAgICAgdm0udG90YWxJdGVtID0gcGRmLm51bVBhZ2VzO1xyXG4gICAgICB2bS5sb2FkZWQgPSB0cnVlO1xyXG4gICAgICB2bS5sb2FkUmVzb3VyY2UoKTtcclxuICAgIH0sIChyZWFzb246IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zb2xlLmVycm9yKHJlYXNvbik7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGxvYWRSZXNvdXJjZSgpIHtcclxuICAgIGNvbnN0IHZtID0gdGhpcztcclxuICAgIGlmICghdm0ubG9hZGVkKSB7XHJcbiAgICAgIHZtLl9wZW5kaW5nUmVsb2FkID0gdHJ1ZTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdm0ubG9hZGVkID0gZmFsc2U7XHJcbiAgICBjb25zdCB1cmwgPSB2bS5zcmM7XHJcbiAgICBjb25zdCBwYWdlID0gdm0uY3VycmVudEl0ZW07XHJcblxyXG4gICAgdm0uX3BkZi5nZXRQYWdlKHBhZ2UpLnRoZW4oKHBkZlBhZ2UpID0+IHtcclxuICAgICAgdm0uX3BhZ2UgPSBwZGZQYWdlO1xyXG4gICAgICB2bS5sb2FkSW1hZ2UodXJsLCBwYWdlLCAoKSA9PiB7XHJcbiAgICAgICAgdm0ubG9hZGVkID0gdHJ1ZTtcclxuICAgICAgICB2bS5sb2FkaW5nID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKHZtLl9wZW5kaW5nUmVsb2FkKSB7XHJcbiAgICAgICAgICB2bS5fcGVuZGluZ1JlbG9hZCA9IGZhbHNlO1xyXG4gICAgICAgICAgdm0ubG9hZFJlc291cmNlKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHZtLnJlc291cmNlQ2hhbmdlLm5leHQoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGxvYWRJbWFnZShzcmM6IHN0cmluZywgcGFnZTogbnVtYmVyLCBvbkZpbmlzaDogKCkgPT4gdm9pZCkge1xyXG4gICAgY29uc3Qgdm0gPSB0aGlzO1xyXG4gICAgY29uc3QgY2FjaGVpbWcgPSB2bS5faW1hZ2VDYWNoZS5nZXRJbWFnZShzcmMsIHBhZ2UpO1xyXG4gICAgaWYgKGNhY2hlaW1nKSB7XHJcbiAgICAgIHZtLl9pbWFnZSA9IGNhY2hlaW1nO1xyXG4gICAgICBvbkZpbmlzaCgpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xyXG4gICAgY29uc3QgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xyXG4gICAgY29uc3QgcGFnZVZwID0gdm0uX3BhZ2UuZ2V0Vmlld3BvcnQoMik7XHJcblxyXG4gICAgY2FudmFzLndpZHRoID0gcGFnZVZwLndpZHRoO1xyXG4gICAgY2FudmFzLmhlaWdodCA9IHBhZ2VWcC5oZWlnaHQ7XHJcblxyXG4gICAgY29uc3QgcmVuZGVyQ29udGV4dCA9IHtcclxuICAgICAgY2FudmFzQ29udGV4dDogY29udGV4dCxcclxuICAgICAgdmlld3BvcnQ6IHBhZ2VWcFxyXG4gICAgfTtcclxuICAgIGNvbnN0IHJlbmRlclRhc2sgPSB2bS5fcGFnZS5yZW5kZXIocmVuZGVyQ29udGV4dCk7XHJcbiAgICByZW5kZXJUYXNrLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICBjYW52YXMudG9CbG9iKGJsb2IgPT4ge1xyXG4gICAgICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xyXG4gICAgICAgIGltZy5vbmxvYWQgPSBvbkZpbmlzaDtcclxuICAgICAgICBpbWcuc3JjID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTtcclxuICAgICAgICB2bS5faW1hZ2VDYWNoZS5zYXZlSW1hZ2Uoc3JjLCBwYWdlLCBpbWcpO1xyXG4gICAgICAgIHZtLl9pbWFnZSA9IGltZztcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuIl19